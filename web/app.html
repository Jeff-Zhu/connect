<!DOCTYPE html>
<html lang="en" dir="ltr">

  <head>
    <title>Jitsi-bot</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Materialize CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

    <!-- Materialize JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  </head>

  <body onload="connectMQTT()" style="background-color:black;">
    <!-- Header-->
    <div id="jitsi-meet"></div>
    
    <!-- Footer-->
    <footer id="footer" class="page-footer">
      <!-- Copyright-->
      <div class="footer-copyright text-center py-3">
        <p>© 2020 hapi-robo st, Inc. — All Rights Reserved.</p>
      </div>
    </footer>

    <!-- Jitsi-->
    <!-- https://github.com/jitsi/jitsi-meet/blob/master/doc/api.md -->
    <script src="https://meet.jit.si/external_api.js"></script>
    <script>
      var domain = "meet.jit.si";
      var options = {
          roomName: "temi-0123456",
          // width: window.innerWidth;
          // height: window.innerHeight;
          parentNode: document.getElementById('jitsi-meet'),
          configOverwrite: {},
          interfaceConfigOverwrite: {
              filmStripOnly: false
          }
      }
      var api = new JitsiMeetExternalAPI(domain, options);
    </script>

    <!-- Paho MQTT-->
    <!-- https://github.com/eclipse/paho.mqtt.javascript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/mqttws31.min.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script> -->
    <script>
      const MQTT_BROKER_HOST = 'localhost'; // TODO Get this automatically
      const MQTT_BROKER_PORT = 9001; // MQTT with websocket port

      let client;

      /*
       * Connect to MQTT broker
       * ref: https://www.eclipse.org/paho/files/jsdoc/Paho.MQTT.Client.html
       */
      function connectMQTT() {
        console.log(`Connecting to ${MQTT_BROKER_HOST}:${MQTT_BROKER_PORT}`);

        // @TODO Provide a unique identifier
        client = new Paho.MQTT.Client(MQTT_BROKER_HOST, MQTT_BROKER_PORT, 'jitsi-temi-client');

        // sniff and display messages on MQTT bus
        // client.onMessageArrived = onMessageArrived;
        
        let options = {
          // connection attempt timeout in seconds
          timeout: 3,

          // on successful connection
          onSuccess: function() {
            console.log('Success');

            // @TODO Write handlers
            // client.subscribe('temi/#');
          },

          // on failed connection
          onFailure: function(message) {
            console.log(`Fail: ${message.errorMessage}`);
          }
        };

        // attempt to connect
        client.connect(options);
      }

      /*
       * Keyboard listener
       *
       * Reference
       *  - https://keycode.info/
       */
      document.addEventListener('keydown', function(event) {
        switch (event.keyCode) {
          case 37: // ArrowLeft
          case 65: // a
            console.log('[Keycode] ArrowLeft / a');
            onTurnLeft()
            break;
          case 39: // ArrowRight
          case 68: // d
            console.log('[Keycode] ArrowRight / d');
            onTurnRight()
            break;
          case 38: // ArrowUp
          case 87: // w
            console.log('[Keycode] ArrowUp / w');
            onMoveForward()
            break;
          case 40: // ArrowDown
          case 83: // s
            console.log('[Keycode] ArrowDown / s');
            onMoveBackward()
            break;
        }

        if (event.ctrlKey) {
          switch (event.keyCode) {
            case 70: // CTRL + f
              console.log('[Keycode] CTRL + f');
              onFollow();
              break;
          }
        }
      });

      /**
       * Turn left
       */
      function onTurnLeft() {
        console.log('[SEND] Turn Left');

        // write payload in JSON format
        let payload = JSON.stringify({
          angle: +45
        });

        // publish message
        let message = new Paho.MQTT.Message(payload);
        message.destinationName = 'temi/movement/turn_by';
        message.qos = 0;
        client.send(message);
      }

      /**
       * Turn right
       */
      function onTurnRight() {
        console.log('[SEND] Turn Right');

        // write payload in JSON format
        let payload = JSON.stringify({
          angle: -45
        });

        // publish message
        let message = new Paho.MQTT.Message(payload);
        message.destinationName = 'temi/movement/turn_by';
        message.qos = 0;
        client.send(message);
      }

      /**
       * Move forward
       */
      function onMoveForward() {
        console.log('[SEND] Move Forward');

        // write payload in JSON format
        let payload = JSON.stringify({
          x: +5,
          y: 0
        });

        // publish message
        let message = new Paho.MQTT.Message(payload);
        message.destinationName = 'temi/movement/joystick';
        message.qos = 0;
        client.send(message);
      }

      /**
       * Move backward
       */
      function onMoveBackward() {
        console.log('[SEND] Move Backward');

        // write payload in JSON format
        let payload = JSON.stringify({
          x: -5,
          y: 0
        });

        // publish message
        let message = new Paho.MQTT.Message(payload);
        message.destinationName = 'temi/movement/joystick';
        message.qos = 0;
        client.send(message);
      }

      /**
       * Follow
       */
      function onFollow() {
        console.log('[SEND] Follow');

        // write payload in JSON format
        let payload = JSON.stringify({});

        // publish message
        let message = new Paho.MQTT.Message(payload);
        message.destinationName = 'temi/follow/unconstrained';
        message.qos = 1;
        client.send(message);
      }

      /**
       * Go-to
       */
      function onGoto() {
        // let goto_list = document.getElementById('goto-list');
        // let selection = goto_list.options[goto_list.selectedIndex].text;
        // console.log(`[SEND][GoTo]: ${selection}`);

        // write payload in JSON format
        // let payload = JSON.stringify({
        //   location: selection
        // });

        // fill payload
        let message = new Paho.MQTT.Message(payload);
        message.destinationName = 'temi/locations/goto';
        message.qos = 1;
        client.send(message);
      }

    </script>
  </body>

</html>